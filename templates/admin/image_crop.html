{% extends "admin/base_site.html" %}
{% load static %}

{% block extrahead %}
    {{ block.super }}
    <style>
        .image-container {
            position: relative;
            overflow: auto;
            max-height: 600px;
            border: 1px solid #ddd;
            margin-bottom: 20px;
        }

        #imageCanvas {
            position: absolute;
            top: 0;
            left: 0;
            cursor: crosshair;
        }

        .controls {
            margin: 20px 0;
            display: grid;
            grid-gap: 15px;
            max-width: 600px;
        }

        .control-group {
            display: grid;
            grid-gap: 5px;
        }

        .button {
            background: #79aec8;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            color: white;
            cursor: pointer;
        }

        .button:hover {
            background: #609ab6;
        }

        input[type="text"],
        select,
        textarea {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 100%;
        }

        label {
            font-weight: bold;
            color: #666;
        }
    </style>
{% endblock %}

{% block content %}
    <div id="content-main">
        <div class="image-container">
            <img id="originalImage" src="{{ wall_image_url }}" style="display: block;">
            <canvas id="imageCanvas"></canvas>
        </div>
        <div class="controls">
            <div class="control-group">
                <label for="identifier">Identifier</label>
                <input type="text" id="identifier" placeholder="Enter identifier">
            </div>
            <div class="control-group">
                <label for="graffitiType">Graffiti Type</label>
                <select id="graffitiType">
                    <option value="">Select type...</option>
                    {% for value, label in graffiti_types %}
                        <option value="{{ value }}">{{ label }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="control-group">
                <label for="description">Description</label>
                <textarea id="description" rows="3"></textarea>
            </div>
            <div class="control-group">
                <label for="tags">Tags (comma-separated)</label>
                <input type="text" id="tags" placeholder="Enter tags">
            </div>
            <div class="control-group">
                <label>
                    <input type="checkbox" id="isPartOf" checked>
                    Is part of this wall
                </label>
            </div>
            <button onclick="saveDerivedGraffiti()" class="button">Save Graffiti Photo</button>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('imageCanvas');
        const ctx = canvas.getContext('2d');
        const img = document.getElementById('originalImage');
        let isDrawing = false;
        let startX, startY;
        let currentRect = null;

        img.onload = function () {
            canvas.width = img.width;
            canvas.height = img.height;
        };

        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDrawing);

        function startDrawing(e) {
            isDrawing = true;
            const rect = canvas.getBoundingClientRect();
            startX = e.clientX - rect.left + canvas.parentElement.scrollLeft;
            startY = e.clientY - rect.top + canvas.parentElement.scrollTop;
        }

        function draw(e) {
            if (!isDrawing) return;

            const rect = canvas.getBoundingClientRect();
            const currentX = e.clientX - rect.left + canvas.parentElement.scrollLeft;
            const currentY = e.clientY - rect.top + canvas.parentElement.scrollTop;

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            ctx.beginPath();
            ctx.strokeStyle = '#79aec8';
            ctx.lineWidth = 2;

            const width = currentX - startX;
            const height = currentY - startY;

            ctx.strokeRect(startX, startY, width, height);
            ctx.fillStyle = 'rgba(121, 174, 200, 0.3)';
            ctx.fillRect(startX, startY, width, height);

            currentRect = {
                x: Math.min(startX, currentX),
                y: Math.min(startY, currentY),
                width: Math.abs(width),
                height: Math.abs(height)
            };
        }

        function stopDrawing() {
            isDrawing = false;
        }

        function saveDerivedGraffiti() {
            if (!currentRect) {
                alert('Please draw a selection first');
                return;
            }

            const identifier = document.getElementById('identifier').value;
            if (!identifier) {
                alert('Please enter an identifier');
                return;
            }

            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = currentRect.width;
            tempCanvas.height = currentRect.height;
            const tempCtx = tempCanvas.getContext('2d');

            tempCtx.drawImage(
                img,
                currentRect.x,
                currentRect.y,
                currentRect.width,
                currentRect.height,
                0,
                0,
                currentRect.width,
                currentRect.height
            );

            const payload = {
                image: tempCanvas.toDataURL('image/png'),
                wall_id: {{ graffiti_wall.id }},
                identifier: identifier,
                graffiti_type: document.getElementById('graffitiType').value,
                description: document.getElementById('description').value,
                tags: document.getElementById('tags').value,
                is_part_of: document.getElementById('isPartOf').checked,
                coordinates: {
                    x: currentRect.x,
                    y: currentRect.y,
                    width: currentRect.width,
                    height: currentRect.height
                },
                canvas: JSON.stringify(currentRect)
            };

            fetch('{% url "admin:save-derived-graffiti" %}', {
                method: 'POST',
                body: JSON.stringify(payload)
            })
                .then(response => response.json())
                .then(data => {
                if (data.success) {
                    alert('Graffiti photo saved successfully!');
                    if (window.opener) {
                        window.opener.location.reload();
                    }
                    window.close();
                }
            })
                .catch(error => {
                console.error('Error:', error);
                alert('Error saving graffiti photo');
            });
        }
    </script>
{% endblock %}
